<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Meus Dados</title>
</head>

<body>
    <h1>Meus Dados</h1>

    <form id="formMeusDados">
        <label>Nome completo:</label><br>
        <input type="text" name="nome" required><br><br>

        <label>CPF:</label><br>
        <input type="text" name="cpf" disabled><br><br>

        <label>Email:</label><br>
        <input type="email" name="email" disabled><br><br>

        <label>Data de Nascimento:</label><br>
        <input type="date" name="dataNascimento" required><br><br>

        <label>Gênero:</label><br>
        <select name="genero" required>
            <option value="">Selecione</option>
            <option value="Masculino">Masculino</option>
            <option value="Feminino">Feminino</option>
            <option value="Outro">Outro</option>
        </select><br><br>

        <label>Nova Senha:</label><br>
        <input type="password" name="novaSenha"><br><br>

        <label>Confirmar Nova Senha:</label><br>
        <input type="password" name="confirmarSenha"><br><br>

        <button type="submit">Salvar Alterações</button>
    </form>

    <hr>
    <h2>Endereços de Entrega</h2>
    <div id="lista-enderecos"></div>
    <button id="btnNovoEndereco">+ Adicionar novo endereço</button>

    <!-- Modal Novo Endereço -->
    <div id="modalEndereco" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
        background-color: rgba(0, 0, 0, 0.5); justify-content:center; align-items:center;">
        <div style="background-color:white; padding:20px; border-radius:8px; width:300px;">
            <h3>Novo Endereço</h3>
            <form id="formEndereco">
                <label>CEP:</label><br>
                <input type="text" name="cep" required><br><br>

                <label>Logradouro:</label><br>
                <input type="text" name="logradouro" required><br><br>

                <label>Número:</label><br>
                <input type="text" name="numero" required><br><br>

                <label>Complemento:</label><br>
                <input type="text" name="complemento"><br><br>

                <label>Bairro:</label><br>
                <input type="text" name="bairro" required><br><br>

                <label>Cidade:</label><br>
                <input type="text" name="cidade" required><br><br>

                <label>UF:</label><br>
                <input type="text" name="uf" required><br><br>

                <button type="submit">Salvar</button>
                <button type="button" onclick="fecharModal()">Cancelar</button>
            </form>
            <p id="mensagemEndereco"></p>
        </div>
    </div>

    <script>
        const cliente = JSON.parse(sessionStorage.getItem("clienteLogado"));
        if (!cliente) {
            alert("Você precisa estar logado para acessar esta página.");
            window.location.href = "login-cliente.html";
        }

        const form = document.getElementById("formMeusDados");
        form.nome.value = cliente.nome;
        form.cpf.value = cliente.cpf;
        form.email.value = cliente.email;
        form.dataNascimento.value = formatarDataParaInput(cliente.dataNascimento);
        form.genero.value = cliente.genero;

        function formatarDataParaInput(data) {
            const d = new Date(data);
            const ano = d.getFullYear();
            const mes = String(d.getMonth() + 1).padStart(2, '0');
            const dia = String(d.getDate()).padStart(2, '0');
            return `${ano}-${mes}-${dia}`;
        }

        const lista = document.getElementById("lista-enderecos");
        function renderizarEnderecos() {
            lista.innerHTML = "";
            if (cliente.enderecosEntrega && cliente.enderecosEntrega.length > 0) {
                cliente.enderecosEntrega.forEach((endereco, index) => {
                    const div = document.createElement("div");
                    div.innerHTML = `
                        <label>
                            <input type="radio" name="enderecoPadrao" value="${index}" ${endereco.padrao ? "checked" : ""}>
                            <strong>${endereco.logradouro}, ${endereco.numero}</strong><br>
                            ${endereco.bairro} - ${endereco.cidade}/${endereco.uf}<br>
                            CEP: ${endereco.cep}
                        </label>
                        <hr>
                    `;
                    lista.appendChild(div);
                });
            } else {
                lista.innerHTML = "<p>Nenhum endereço cadastrado ainda.</p>";
            }
        }

        renderizarEnderecos();

        form.addEventListener("submit", async function (e) {
            e.preventDefault();

            const novaSenha = form.novaSenha.value.trim();
            const confirmar = form.confirmarSenha.value.trim();

            if ((novaSenha || confirmar) && novaSenha !== confirmar) {
                alert("As senhas não coincidem.");
                return;
            }

            const dadosAtualizados = {
                id: cliente.id,
                nome: form.nome.value.trim(),
                genero: form.genero.value,
                senha: novaSenha || null
            };

            try {
                const response = await fetch("http://localhost:8080/api/cliente/atualizar", {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify(dadosAtualizados)
                });

                const msg = await response.text();
                alert(msg);

                if (response.ok) {
                    cliente.nome = dadosAtualizados.nome;
                    cliente.genero = dadosAtualizados.genero;
                    sessionStorage.setItem("clienteLogado", JSON.stringify(cliente));
                    location.reload();
                }
            } catch (err) {
                alert("Erro ao atualizar dados.");
            }
        });

        document.getElementById("btnNovoEndereco").addEventListener("click", () => {
            document.getElementById("modalEndereco").style.display = "flex";
        });

        function fecharModal() {
            document.getElementById("modalEndereco").style.display = "none";
            document.getElementById("formEndereco").reset();
            document.getElementById("mensagemEndereco").innerText = "";
        }

        document.getElementById("formEndereco").cep.addEventListener("blur", async function () {
            const cep = this.value.replace(/\D/g, "");
            if (cep.length !== 8) return;

            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await response.json();

                if (!data.erro) {
                    this.form.logradouro.value = data.logradouro;
                    this.form.bairro.value = data.bairro;
                    this.form.cidade.value = data.localidade;
                    this.form.uf.value = data.uf;
                } else {
                    document.getElementById("mensagemEndereco").innerText = "CEP não encontrado.";
                }
            } catch {
                document.getElementById("mensagemEndereco").innerText = "Erro ao buscar o CEP.";
            }
        });

        document.getElementById("formEndereco").addEventListener("submit", async function (e) {
            e.preventDefault();
            const form = e.target;

            const cep = form.cep.value.replace(/\D/g, "");

            if (cep.length !== 8) {
                document.getElementById("mensagemEndereco").innerText = "CEP inválido. Deve conter 8 dígitos.";
                return;
            }

            // Validação de CEP com ViaCEP antes de continuar
            let dadosViaCEP;
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                dadosViaCEP = await response.json();

                if (dadosViaCEP.erro) {
                    document.getElementById("mensagemEndereco").innerText = "CEP não encontrado.";
                    return;
                }
            } catch {
                document.getElementById("mensagemEndereco").innerText = "Erro ao validar o CEP com o ViaCEP.";
                return;
            }

            const endereco = {
                cep: cep,
                logradouro: form.logradouro.value.trim(),
                numero: form.numero.value.trim(),
                complemento: form.complemento.value.trim(),
                bairro: form.bairro.value.trim(),
                cidade: form.cidade.value.trim(),
                uf: form.uf.value.trim()
            };

            try {
                const response = await fetch("http://localhost:8080/api/cliente/endereco", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify(endereco)
                });

                const texto = await response.text();
                document.getElementById("mensagemEndereco").innerText = texto;

                if (response.ok) {
                    cliente.enderecosEntrega.push(endereco);
                    sessionStorage.setItem("clienteLogado", JSON.stringify(cliente));
                    renderizarEnderecos();
                    fecharModal();
                }
            } catch {
                document.getElementById("mensagemEndereco").innerText = "Erro ao salvar o endereço.";
            }
        });

        document.addEventListener("change", async (e) => {
            if (e.target.name === "enderecoPadrao") {
                const novoIndex = parseInt(e.target.value);
                const idEndereco = cliente.enderecosEntrega[novoIndex].id;

                const confirmar = confirm("Deseja tornar este o novo endereço padrão?");
                if (!confirmar) {
                    renderizarEnderecos();
                    return;
                }

                try {
                    const response = await fetch(`http://localhost:8080/api/cliente/endereco/${idEndereco}/definir-padrao`, {
                        method: "PUT",
                        credentials: "include"
                    });

                    const msg = await response.text();
                    alert(msg);

                    if (response.ok) {
                        cliente.enderecosEntrega.forEach((end, i) => {
                            end.padrao = i === novoIndex;
                        });
                        sessionStorage.setItem("clienteLogado", JSON.stringify(cliente));
                        renderizarEnderecos();
                    }
                } catch (err) {
                    alert("Erro ao atualizar o endereço padrão.");
                }
            }
        });

    </script>
</body>

</html>